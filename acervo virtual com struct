#include <iostream>
#include <cstring>
#include <cstdlib>
#include <cctype>
#define tsem 7
#define tmax 6
using namespace std;

typedef struct{
    string hinicial, hfinal, tipo, local, asst;
}Compromisso;

typedef struct{
    string dma, diasem;
    int m=0;
    Compromisso comp[tmax];
}Agenda;

char menu();
void toUpper(string&);
bool verificaSeDifDig(string);
bool verificaSeDifLet(string);
void diasSemana(Agenda[]);
void converteMes(string&);
bool validaData(string,string);
bool validaHora(string);
bool validaHoraInicialxFinal(string,string);
int pesquisaDataERetornaPos(int,Agenda[],string);
int pesquisaHoraERetornaPos(int,Agenda[],string,int);
int ordenaComp(int,Agenda[],int,int);
string entradaDeDadosData();
void iniciaSemana(int,Agenda[]);
void incluiCompromisso(int,Agenda[]);
void excluiCompromisso(int,Agenda[]);
void relatorio1(int,Agenda[]);
void relatorio2(int,Agenda[]);

int main()
{
    char ch;
    int n=7;
    bool resp;
    Agenda data[tsem];

    do{
        diasSemana(data);
        do{
            resp=true;
            ch=menu();
            if(!isdigit(ch)){
                resp=false;
                system("cls");
                cout << "Tente novamente." << endl;
                system("pause");
                system("cls");
            }
        }while(!resp);
        switch(ch)
        {
            case '1':
                system("cls");
                cin.ignore();
                iniciaSemana(n,data);
                system("pause");
                break;
            case '2':
                system("cls");
                cin.ignore();
                incluiCompromisso(n,data);
                system("pause");
                break;
            case '3':
                system("cls");
                cin.ignore();
                //excluiCompromisso(n,data);
                system("pause");
                break;
            case '4':
                system("cls");
                cin.ignore();
                relatorio1(n,data);
                system("pause");
                break;
            case '5':
                system("cls");
                cin.ignore();
                relatorio2(n,data);
                system("pause");
                break;
            default:
                if(ch!='6'){
                    system("cls");
                    cin.ignore();
                    cout << "Tente novamente." << endl;
                    system("pause");
                }
        }
        system("cls");
    }while(ch!='6');

    cout << "Boa semana!";

    return 0;
}

char menu()
{
    char ch;
    cout << "--------------MENU---------------";
    cout << "\n1 - INICIAR NOVA SEMANA";
    cout << "\n2 - INCLUIR COMPROMISSO";
    cout << "\n3 - EXCLUIR COMPROMISSO";
    cout << "\n4 - RELATORIO 1: COMPROMISSOS DO DIA";
    cout << "\n5 - RELATORIO 2: AGENDA SEMANAL";
    cout << "\n6 - SAIR" << endl;
    cin >> ch;
    return ch;
}

void toUpper(string &aux)
{
    char a;
    string aux2="";
    for(unsigned int i=0;i<aux.size();i++){
        a=toupper(aux[i]);
        aux2+=a;
    }
    aux=aux2;
}

bool validacaoVazio(string aux)
{
    if(aux.size()==0)
        return false;
    return true;
}

bool verificaSeDifDig(string aux)
{
    for(unsigned int i=0;i<aux.size();i++)
        if(!isdigit(aux.at(i)))
            return false;
    return true;
}

bool verificaSeDifLet(string aux)
{
    for(unsigned int i=0;i<aux.size();i++)
        if(!isalpha(aux.at(i)))
            return false;
    return true;
}

void diasSemana(Agenda data[])
{
    data[0].diasem="DOMINGO";
    data[1].diasem="SEGUNDA";
    data[2].diasem="TERCA";
    data[3].diasem="QUARTA";
    data[4].diasem="QUINTA";
    data[5].diasem="SEXTA";
    data[6].diasem="SABADO";
}

void converteMes(string &mes)
{
    if(mes=="JANEIRO") mes="01";
    if(mes=="FEVEREIRO") mes="02";
    if(mes=="MARCO") mes="03";
    if(mes=="ABRIL") mes="04";
    if(mes=="MAIO") mes="05";
    if(mes=="JUNHO") mes="06";
    if(mes=="JULHO") mes="07";
    if(mes=="AGOSTO") mes="08";
    if(mes=="SETEMBRO") mes="09";
    if(mes=="OUTUBRO") mes="10";
    if(mes=="NOVEMBRO") mes="11";
    if(mes=="DEZEMBRO") mes="12";
}

bool validaData(string mes, string dia)
{
    int dias;
    bool resp;
    resp=validacaoVazio(mes);
    if(!resp) return false;
    resp=validacaoVazio(dia);
    if(!resp) return false;
    resp=verificaSeDifLet(mes);
    if(!resp) return false;
    resp=verificaSeDifDig(dia);
    if(!resp) return false;
    if(dia.size()!=2) return false;
    dias=atoi(dia.c_str());
    if(mes=="JANEIRO" || mes=="MARCO" || mes=="MAIO" || mes=="JULHO" || mes=="AGOSTO" || mes=="OUTUBRO" || mes=="DEZEMBRO"){
        if(dias<1 || dias>31) return false;
        return true;
    }
    if(mes=="FEVEREIRO"){
        if(dias<1 || dias>28) return false;
        return true;
    }
    if(mes=="ABRIL" || mes=="JUNHO" || mes=="SETEMBRO" || mes=="NOVEMBRO"){
        if(dias<1 || dias>30) return false;
        return true;
    }
    return false;
}

bool validaHora(string aux)
{
    string hora="", minuto="";
    int horas, minutos;
    bool resp;
    resp=validacaoVazio(aux);
    if(!resp) return false;
    if(aux.size()!=5) return false;
    for(unsigned int i=0;i<aux.size();i++)
        if(!isdigit(aux.at(i)) && aux.at(i)!=':')
            return false;

    hora+=aux.at(0);
    hora+=aux.at(1);
    horas=atoi(hora.c_str());
    minuto+=aux.at(3);
    minuto+=aux.at(4);
    minutos=atoi(minuto.c_str());

    if(horas<0 || horas>23) return false;
    if(minutos<0 || minutos>59) return false;

    return true;
}

bool validaHoraInicialxFinal(string hinicial, string hfinal)
{
    string hora, minuto;
    int hini, hfin, mini, mfin;
    
    hora=hinicial.at(0);
    hora+=hinicial.at(1);
    hini=atoi(hora.c_str());
    minuto=hinicial.at(3);
    minuto+=hinicial.at(4);
    mini=atoi(minuto.c_str());
    
    hora=hfinal.at(0);
    hora+=hfinal.at(1);
    hfin=atoi(hora.c_str());
    minuto=hfinal.at(3);
    minuto+=hfinal.at(4);
    mfin=atoi(minuto.c_str());
    
    if(mini>=mfin){
        if(hini>=hfin) return false;
        return true;
    }
    else{
        if(hini<=hfin) return true;
        return false;
    }
    
}

int pesquisaDataERetornaPos(int n, Agenda data[], string aux)
{
    if(aux==data[n].dma)
        return n;
    if(n==0)
        return -1;
    return pesquisaDataERetornaPos(n-1,data,aux);
}

int pesquisaHoraERetornaPos(int n, Agenda data[], string aux, int m)
{
    if(aux==data[n].comp[m].hinicial)
        return m;
    if(m==0)
        return -1;
    return pesquisaHoraERetornaPos(n,data,aux,m-1);
}

int ordenaComp(int n, Agenda data[], int m, int posdia)
{
    unsigned int i=0, pos=0, j=1;
    
    if(m==0)
        return m;
    else{
        pos=i;
        if(data[posdia].comp[j].hinicial < data[posdia].comp[pos].hinicial){
            pos=j;
            i++;
            j++;
        }
        swap(data[posdia].comp[pos].hinicial, data[posdia].comp[i].hinicial); 
        swap(data[posdia].comp[pos].hfinal, data[posdia].comp[i].hfinal);
        swap(data[posdia].comp[pos].tipo, data[posdia].comp[i].tipo);
        swap(data[posdia].comp[pos].local, data[posdia].comp[i].local);
        swap(data[posdia].comp[pos].asst, data[posdia].comp[i].asst);
    }
    return ordenaComp(n,data,m-1,posdia);
}

string entradaDeDadosData()
{
    string mes, dia, aux;
    bool resp;
    cout << "Ano: 2022" << endl;
    do{
        cout << "Informe o mês (formato: Janeiro, Fevereiro, etc): ";
        getline(cin,mes);
        toUpper(mes);
        cout << "Informe o dia (formato de dois dígitos: 01, 02,..., 21, etc): ";
        getline(cin,dia);
        resp=validaData(mes,dia);
        if(!resp){
            cout << "Dados inconsistentes. Tente novamente." << endl;
            cout << endl;
        }
    }while(!resp);
    converteMes(mes);
    aux=dia+'/'+mes+'/'+"2022";
    return aux;
}


void iniciaSemana(int n, Agenda data[])
{
    char ch;
    string aux, dia="", mes="", ano="2022";
    int dint, mint;
    Agenda auxa;

    do{
        cout << "Confirme sua escolha. Iniciar nova semana? [S/N]" << endl;
        ch=toupper(cin.get());
    }while(ch!='S' && ch!='N');
    system("cls");
    cin.ignore();
    if(ch=='S'){
        cout << "Escolha confirmada: iniciar." << endl;
        cout << endl;
        aux=entradaDeDadosData();
        dia+=aux.at(0);
        dia+=aux.at(1);
        dint=atoi(dia.c_str());
        mes+=aux.at(3);
        mes+=aux.at(4);
        mint=atoi(mes.c_str());

        for(unsigned int i=0;i<n;i++){
            data[i].dma=aux;
            dint++;
            dia=to_string(dint);
            mes=to_string(mint);
            if(dint<10) dia='0'+dia;
            if(mint<10) mes='0'+mes;
            aux=dia+'/'+mes+'/'+ano;
            if(mint==2)
                if(dint==28){
                    dint=0;
                    mint++;
                }
            if(mint==4 || mint==6 || mint==9 || mint==11)
                if(dint==30){
                    dint=0;
                    mint++;
                }
            if(dint==31){
                if(mint==12){
                    mint=0;
                    ano="2023";
                }
                dint=0;
                mint++;
            }
        }
        cout << endl;
        cout << "Agenda inicializada." << endl;
    }
    else cout << "Escolha confirmada: nao iniciar." << endl;
}


void incluiCompromisso(int n,Agenda data[])
{
    int posdia,poshora, aux;
    bool resp,resp2;
    Agenda auxa;
    Compromisso auxc;
    cout << "INCLUSAO DE COMPROMISSO" << endl;
    cout << endl;
    auxa.dma=entradaDeDadosData();
    cout << "Data: " << auxa.dma << endl;
    posdia=pesquisaDataERetornaPos(n,data,auxa.dma);
    if(posdia!=-1){
        if(auxa.m<7){
            do{
                cout << "Informe a hora (formato: 00:00): ";
                getline(cin,auxc.hinicial);
                resp=validaHora(auxc.hinicial);
                if(!resp)
                    cout << "Dados inconsistentes. Tente novamente." << endl;
            }while(!resp);
            poshora=pesquisaHoraERetornaPos(posdia,data,auxc.hinicial,data[posdia].m);
            if(poshora==-1){
                do{
                    cout << "Informe a hora final (formato: 00:00): ";
                    getline(cin,auxc.hfinal);
                    resp=validaHora(auxc.hfinal);
                    resp2=validaHoraInicialxFinal(auxc.hinicial,auxc.hfinal);
                    if(!resp || !resp2)
                        cout << "Dados inconsistentes. Tente novamente." << endl;
                }while(!resp || !resp2);

                do{
                    cout << "Informe o tipo: ";
                    getline(cin,auxc.tipo);
                    toUpper(auxc.tipo);
                    resp=validacaoVazio(auxc.tipo);
                    resp2=verificaSeDifLet(auxc.tipo);
                    if(!resp || !resp2)
                        cout << "Dados inconsistentes. Tente novamente." << endl;
                }while(!resp || !resp2);
                do{
                    cout << "Informe o local: ";
                    getline(cin,auxc.local);
                    toUpper(auxc.local);
                    resp=validacaoVazio(auxc.local);
                }while(!resp);
                do{
                    cout << "Informe o assunto: ";
                    getline(cin,auxc.asst);
                    toUpper(auxc.asst);
                    resp=validacaoVazio(auxc.asst);
                }while(!resp);

                auxa.m++;
                data[posdia]=auxa;
                //cout << "parou aqui" << endl;
                data[posdia].comp[posdia]=auxc;
                cout << "Compromisso incluido." << endl;
                aux=ordenaComp(n,data,data[posdia].m,posdia);
            }
            else cout << "Horario ja ocupado." << endl;
        }
        else cout << "Você ja atingiu o limite de compromissos marcados por dia. Máximo: 6" << endl;
    }
    else cout << "Data nao encontrada." << endl;
}

void excluiCompromisso(int n, Agenda data[])
{
    char ch;
    string aux;
    int posdia, poshora;
    bool resp;
    
    cout << "EXCLUSAO DE COMPROMISSO" << endl;
    cout << endl;
    aux=entradaDeDadosData();
    cout << "Data: " << aux << endl;
    posdia=pesquisaDataERetornaPos(n,data,aux);
    if(posdia!=-1){
        do{
            cout << "Informe o horario (formato: 00:00): ";
            getline(cin,aux);
            resp=validaHora(aux);
            if(!resp)
                cout << "Dados inconsistentes. Tente novamente." << endl;
        }while(!resp);
        poshora=pesquisaHoraERetornaPos(posdia,data,aux,data[posdia].m);
        if(poshora!=-1){
            cout << endl;
            //cout << data[]
            do{
                cout << "Confirme sua escolha. Excluir compromisso? [S/N]" << endl;
                ch=toupper(cin.get());
            }while(ch!='S' && ch!='N');
        }
        else cout << "Horario nao encontrado." << endl;
    }
    else cout << "Data nao encontrada." << endl;
}

void relatorio1(int n, Agenda data[])
{
    string aux;
    int pos;
    cout << "RELATORIO DIARIO" << endl;
    cout << endl;
    aux=entradaDeDadosData();
    pos=pesquisaDataERetornaPos(n,data,aux);
    system("cls");
    system("pause");
    if(pos!=-1){
        if(data[pos].m==0) cout << "Sem compromissos nesta data." << endl;
        else{
            cout << "Data: " << data[pos].dma << endl;
            cout << endl;
            for(unsigned int i=0;i<data[pos].m;i++){
                cout << "Hora inicial: " << data[pos].comp[i].hinicial << endl;
                cout << "Hora final: " << data[pos].comp[i].hfinal << endl;
                cout << "Tipo: " << data[pos].comp[i].tipo << endl;
                cout << "Local: " << data[pos].comp[i].local << endl;
                cout << "Assunto: " << data[pos].comp[i].asst << endl;
                cout << endl;
            }
        }
    }
    else
        cout << "Data não encontrada." << endl;

}

void relatorio2(int n, Agenda data[])
{
    cout << "RELATORIO SEMANAL" << endl;
    cout << endl;
    for(unsigned int i=0;i<n;i++){
        cout << data[i].dma << endl;
        cout << data[i].diasem << endl;
        cout << data[i].m << " compromissos." << endl;
        cout << endl;
    }
}
